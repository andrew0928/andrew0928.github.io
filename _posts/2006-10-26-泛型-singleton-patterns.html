---
layout: post
title: "泛型 + Singleton Patterns"
categories:
- ".NET"
tags: []
published: true
comments: true
---
<p><p>聽起來 singleton 跟 generic 好像搭不上邊, 不過搭配 .net framework 2.0 的 generic 機制, 倒是可以讓 singleton 好做很多... 我先簡單寫一下不使用 generic 時的做法...</p>
<p>只有單一 class 要實作 singleton 很簡單, 只要寫這樣的 code 就可以:</p>
<div class="code">
<div style="FONT-SIZE: 12pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: fixedsys">
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;&nbsp;7</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">class</span> <span style="COLOR: teal">SampleSingletonClass</span></p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;&nbsp;8</span>&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;&nbsp;9</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: blue">private</span> <span style="COLOR: blue">static</span> <span style="COLOR: teal">SampleSingletonClass</span> _instance = <span style="COLOR: blue">null</span>;</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;10</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">static</span> <span style="COLOR: teal">SampleSingletonClass</span> Instance</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;11</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;12</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: blue">get</span></p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;13</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;14</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: blue">if</span> (_instance == <span style="COLOR: blue">null</span>)</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;15</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;16</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _instance = <span style="COLOR: blue">new</span> <span style="COLOR: teal">SampleSingletonClass</span>();</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;17</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;18</span>&nbsp;</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;19</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: blue">return</span> _instance;</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;20</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;21</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;22</span>&nbsp;</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;23</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: blue">private</span> SampleSingletonClass()</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;24</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;25</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: green">//</span></p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;26</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: green">//&nbsp; ToDo: constructor code here.</span></p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;27</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: green">//</span></p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;28</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;29</span>&nbsp;&nbsp;&nbsp;&nbsp; }</p></div></div>
<p>&nbsp;很標準的 code, 不是嗎? 不過問題來了... 當我有第二個 class 也要套用 singleton patterns 時, 幾乎一樣的 code 就得再抄一次, 只因為 public static XXX Instance; 這個 static property 的型別不一樣, 很討厭...</p>
<p>這堆看起來差不多的 code 想要省掉, 那只好動點手腳, 用繼承的技術解決, 不過問題又來了, 型別的宣告... 就像一堆 Collection 物件一樣, 傳回型別宣告為 object 就好了, 不過這樣的 code 用起來實在麻煩... 寫起來就像這樣:</p>
<div class="code"><!--<br>
{\rtf1\ansi\ansicpg\lang1024\noproof950\uc1 \deff0{\fonttbl{\f0\fnil\fcharset136\fprq1 Fixedsys;}}{\colortbl;\red0\green0\blue0;\red0\green0\blue255;\red0\green255\blue255;\red0\green255\blue0??;\red255\green0\blue255;\red255\green0\blue0;\red255\green255\blue0;\red255\green255\blue255;??\red0\green0\blue128;\red0\green128\blue128;\red0\green128\blue0;??\red128\green0\blue128;\red128\green0\blue0;\red128\green128\blue0;\red128\green128\blue128;??\red192\green192\blue192;}??\fs24     \cf2 public\cf0  \cf2 class\cf0  \cf10 SingletonBase\par ??\cf0     \{\par ??        \cf2 public\cf0  \cf2 static\cf0  \cf10 SingletonBase\cf0  Instance(\cf10 Type\cf0  seed)\par ??        \{\par ??            \cf2 if\cf0  (_singleton_storage[seed] == \cf2 null\cf0 )\par ??            \{\par ??                _singleton_storage[seed] = \cf10 Activator\cf0 .CreateInstance(seed);\par ??            \}\par ??\par ??            \cf2 return\cf0  _singleton_storage[seed] \cf2 as\cf0  \cf10 SingletonBase\cf0 ;\par ??        \}\par ??\par ??        \cf2 private\cf0  \cf2 static\cf0  \cf10 Hashtable\cf0  _singleton_storage = \cf2 new\cf0  \cf10 Hashtable\cf0 ();\par ??    \}\par ??\par ??    \cf2 public\cf0  \cf2 class\cf0  \cf10 SingletonBaseImpl1\cf0  : \cf10 SingletonBase\par ??\cf0     \{\par ??        \cf2 public\cf0  SingletonBaseImpl1()\par ??            : \cf2 base\cf0 ()\par ??        \{\par ??            \cf10 Console\cf0 .WriteLine(\cf13 "SingletonBaseImpl1.ctor() called."\cf0 );\par ??        \}\par ??    \}\par ??\par ??    \cf2 public\cf0  \cf2 class\cf0  \cf10 SingletonBaseImpl2\cf0  : \cf10 SingletonBase\par ??\cf0     \{\par ??        \cf2 public\cf0  SingletonBaseImpl2()\par ??            : \cf2 base\cf0 ()\par ??        \{\par ??            \cf10 Console\cf0 .WriteLine(\cf13 "SingletonBaseImpl2.ctor() called."\cf0 );\par ??        \}\par ??    \}\par ??}<br>
-->
<div style="FONT-SIZE: 12pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: fixedsys">
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;&nbsp;8</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">class</span> <span style="COLOR: teal">SingletonBase</span></p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;&nbsp;9</span>&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;10</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">static</span> <span style="COLOR: teal">SingletonBase</span> Instance(<span style="COLOR: teal">Type</span> seed)</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;11</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;12</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: blue">if</span> (_singleton_storage[seed] == <span style="COLOR: blue">null</span>)</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;13</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;14</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _singleton_storage[seed] = <span style="COLOR: teal">Activator</span>.CreateInstance(seed);</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;15</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;16</span>&nbsp;</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;17</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: blue">return</span> _singleton_storage[seed] <span style="COLOR: blue">as</span> <span style="COLOR: teal">SingletonBase</span>;</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;18</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;19</span>&nbsp;</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;20</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: blue">private</span> <span style="COLOR: blue">static</span> <span style="COLOR: teal">Hashtable</span> _singleton_storage = <span style="COLOR: blue">new</span> <span style="COLOR: teal">Hashtable</span>();</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;21</span>&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;22</span>&nbsp;</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;23</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">class</span> <span style="COLOR: teal">SingletonBaseImpl1</span> : <span style="COLOR: teal">SingletonBase</span></p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;24</span>&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;25</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> SingletonBaseImpl1()</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;26</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; : <span style="COLOR: blue">base</span>()</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;27</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;28</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: teal">Console</span>.WriteLine(<span style="COLOR: maroon">"SingletonBaseImpl1.ctor() called."</span>);</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;29</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;30</span>&nbsp;&nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;31</span>&nbsp;</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;32</span>&nbsp;&nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> <span style="COLOR: blue">class</span> <span style="COLOR: teal">SingletonBaseImpl2</span> : <span style="COLOR: teal">SingletonBase</span></p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;33</span>&nbsp;&nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;34</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: blue">public</span> SingletonBaseImpl2()</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;35</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; : <span style="COLOR: blue">base</span>()</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;36</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;37</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: teal">Console</span>.WriteLine(<span style="COLOR: maroon">"SingletonBaseImpl2.ctor() called."</span>);</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;38</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;39</span>&nbsp;&nbsp;&nbsp;&nbsp; }</p></div></div>
<p>看來不怎麼漂亮? 不過看在重複的 code 只寫一次就好的份上, 醜一點關起門來就看不到了. 不過這樣就沒事了? 不... 用起來更醜... [:'(]</p>
<div class="code">
<div style="FONT-SIZE: 12pt; BACKGROUND: white; COLOR: black; FONT-FAMILY: Fixedsys">
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;11</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: teal">SingletonBase</span>.Instance(<span style="COLOR: blue">typeof</span>(<span style="COLOR: teal">SingletonBaseImpl1</span>));</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;12</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: teal">SingletonBase</span>.Instance(<span style="COLOR: blue">typeof</span>(<span style="COLOR: teal">SingletonBaseImpl1</span>));</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;13</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: teal">SingletonBase</span>.Instance(<span style="COLOR: blue">typeof</span>(<span style="COLOR: teal">SingletonBaseImpl1</span>));</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;14</span>&nbsp;</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;15</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: teal">SingletonBase</span>.Instance(<span style="COLOR: blue">typeof</span>(<span style="COLOR: teal">SingletonBaseImpl2</span>));</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;16</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: teal">SingletonBase</span>.Instance(<span style="COLOR: blue">typeof</span>(<span style="COLOR: teal">SingletonBaseImpl2</span>));</p>
<p style="MARGIN: 0px"><span style="COLOR: #2b91af">&nbsp;&nbsp;&nbsp;17</span>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="COLOR: teal">SingletonBase</span>.Instance(<span style="COLOR: blue">typeof</span>(<span style="COLOR: teal">SingletonBaseImpl2</span>));</p></div></div>
<p>&nbsp;</p>
<p>實在無法接受這種 quality 的 "class library" ... 這種 code 看起來一點美感都沒有, 就像文筆不好的人在寫文章一樣...</p>
<p>處女座的個性, 實在不能容忍這種 code 出現在我的 project 裡... 碰到這種問題, 直覺的解決辦法就是:</p>
<ol>
<li>透過 inherence, 把這些重複的 code 集中到 super class 一次解決 
</li><li>同樣邏輯, 要套用到不同型別的應用, 就用 generic 的方式處理</li></ol>
<p>不過要實作還沒那麼簡單, 試了半天, 總算找出一種看起來最得意的解法... &lt;待續&gt;</p></p>
