---
layout: post
title: "微服務架構 #1, WHY and HOW?"
categories:
published: false
comments: true
logo: 
---

八月底，接受了 Microsoft 的邀請，參加了 Community Open Camp 研討會，講了這場 "微服務架構 導入經驗分享 - .NET + Windows Container"。
其實這個主題涵蓋範圍還蠻大的，不過時間只有 40 分鐘，相當有限... 最後當然是略過了很多細節，還蠻可惜的。微服務架構這幾年，因為 Docker 的
流行，解決了微服務架構的系統佈署問題，而熱門了起來，因此這個 session 我就把主題定在分享我自己公司的 project, 如何將傳統的大型 web application
改為 microservice architecture 的經驗談。

其實我準被的內容，包含 demo, 若是要講個 4hr 也是夠講的... XD，裡面其實太多細節跟經驗值得分享的。既然當天的場子講不完，我就整理一下用文字的
方式在這邊分享吧。我會分成這幾個章節，分成三篇文章來說明:
1. 微服務架構設計
2. 必要的技術: 透過 container 佈署服務 (demo: windows container)
3. 實際案例說明 (參考 stackoverflow.com 的架構，及我們公司自己系統的改版經驗)

<!--more-->

# 前言

其實一開始本來有埋了一些梗，後來都拿掉了.. 很多新技術的導入 (尤其是企業內有時程壓力的狀況下)，往往碰到最大的問題都是人，而不是技術本身。
我常跟別人聊到，最頭痛的狀況就是有些專家，他拿他的專業能力來潑你冷水，而不是拿來解決問題。怎麼說? 因為這些專家夠專業，所以能夠馬上舉出
十個新技術的缺點，來說明導入會有什麼困難。就因為這些人是專家，有時你還真沒辦法反駁他。但是很多事情不下定決心改善，是不會成功的。這時如何
說服這些專家，就是推廣新技術能否成功的主要因素了。

隨便舉個例子，下列的對話是真正發生過的 case:
![被刪掉的投影片 - 常會不自覺潑冷水的專家](/wp-content/uploads/2016/09/microservice-slides-03.PNG)

當然，最後我們並沒有被這些冷水澆熄改變架構的念頭 (不然就沒這個分享的 session 了)，第一階段的調整也順利上線，接下來更大規模的佈署則要
看看 windows server 2016 上市之後再來評估... 不過對話內點到兩個問題，就是我們改用微服務架構碰到的困難:
1. 我們是用 .NET solution, 但是理想架構下，同時會需要 .NET + Open Source solutions
2. Open Source solutions 大都是在 Linux 上面的表現最好，大規模佈署的話會有混搭 (windows + linux) 的需要
3. 微服務架構若沒有搭配 container, 佈署過程會變的很辛苦, 可是當紅的 Docker 是依賴 Linux Kernel 的 container engine ...

這些問題，在後面的介紹都會提到如何因應的，因此這邊我就不多說。先從基礎來說明，為何我們需要用微服務架構。


# 微服務(microservices) vs 單體式架構(monolithic)

先來看張圖:
![單體式架構(monolithic) vs 微服務(microservices)](/wp-content/uploads/2016/09/microservice-slides-06.PNG)


## 單體式架構
這張圖應該這樣看，上面的 App1 代表的就是你開發的應用程式。裡面的小方塊，我們可以把他看成你的系統內幾個主要的模組。
過去開發的觀念，這些模組主要都是用 "元件" (component) 或是 "函示庫" (library) 的方式提供，然後由開發人員把他組裝
成你的 App 提供給客戶使用。這種組裝方式，最終會產出一個規模龐大的 App, 就是這張圖左方的 Monolithic application approach 的
例子。

用 "組裝" 的方式，對於 OS 來看，就是一個很大型的 process 而已，只是剛好他的功能很多，但是在 OS 的管理下就是一個應用
程式。出了問題就是以 process 為單位來修復的。舉例來說，當一個模組沒有做好記憶體管理，導致 Out Of Memory Exception, 毀掉的
是整個 process, 而不是單一這個模組。當一個模組 fail, 導致整個 process 掛掉的時候，對，就是整個應用程式掛掉了。

單體式 application 組合出來，就是一個大型 application, 在 OS 的管理角度來看是無法再分割的，因此除了上述的失敗處理之外，
也無法再切割為更小的佈署單位。因此效能不足時，只能整個 application 進行 scale out，而不是針對特定模組做 scale out. 這同時也代表
你無法針對特定模組的資源使用最佳化。

業界對這種問題，自然也有對應的解決方法。比如 windows 可以把部分模組裝到獨立的 app pool, 也可以針對 app pool 做 scale out (新增 worker process)。
在 Java 領域也有 EJB 可以解決這問題，但是這終究是在單體式架構下來解決改善，先天不良的情況下總是有他難以克服的瓶頸。

當然，問題不只發生在佈署，開發階段也是個問題。寫過 code 的都知道，你改了這邊的 code, 問題往往會在看起來不相關的地方冒出來。
為了避免這些問題，嚴謹的團隊修正了任何 code (那怕只有一行)，理論上也要整個 applicaion **完整** 的測是一次才能發行給客戶。
問題就在這個 **完整** 的測試... 程式碼越大，要測試的範圍會以指數遞增的程度增加，升級的風險就會提高。



## 微服務架構
微服務的架構，採取另一個不同的思考方式來解決問題。不知各位是否還記得幾年前很流行的 "服務導向架構" (SOA, Service Oriented Architecture) ?
其實背後的觀念有些是雷同的。就是把單體式的 application, **拆解**為幾個獨立的 application. 只要你拆解的適當，拆解的夠徹底，每個服務
的大小及規模都會受到良好的控制。你會更容易維護，佈署及管理。當單一 application 的規模受到控制之後，單體式架構碰到的問題就再也不存在。

不過，單體式架構下，我只要維護一套服務啊，現在新的問題冒出來了，每個服務都很小，但是服務很多的話，複雜度就出現在管理及開發這麼多服務的身上。
系統的佈署就是第一個大問題。你可以想像安裝一套系統，要裝 10 個database, 30 個 web site, 防火牆及安全性分別顧好這些 application 之間的
存取原則做設定... 將來還要做好這些服務的備份及還原... 更別提這些 application 每個都可以個別 scale out... 
佈署問題是微服務架構面臨的第一個挑戰。

再來就是開發的挑戰了。採用元件或是涵式庫，使用上是相當容易的，通常只要加入參考就可以用。因為這些規格通常是同一種語言，編譯器，平台或是框架
下的產物，使用上完全沒有阻礙。但是服務跟服務之間的挑戰就困難的多，服務之間要互相溝通，一定要透過事先定義好的介面來進行，這通常會是跟平台無關的
API (例如 Http API, or RESTful API)。API 的開發並不難，難在你定義的 AP**I** 是否夠收斂札實? 是否在能達到同樣目的下有最小的介面? 另一個
挑戰是 API 必須有很好的向前相容，因為將來每個服務可能都會個別升級，你會面臨同時有新舊 client 都在使用你的服務，相容性沒做好，服務組成的 application
就會垮台。服務之間的介面設計，是架構師面臨的第二個挑戰。



# 為何要轉移到微服務架構?



