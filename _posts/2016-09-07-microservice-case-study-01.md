---
layout: post
title: "微服務架構 #1, WHY and HOW?"
categories:
published: false
comments: true
logo: 
---

八月底，接受了 Microsoft 的邀請，參加了 Community Open Camp 研討會，講了這場 "微服務架構 導入經驗分享 - .NET + Windows Container"。
其實這個主題涵蓋範圍還蠻大的，不過時間只有 40 分鐘，相當有限... 最後當然是略過了很多細節，還蠻可惜的。微服務架構這幾年，因為 Docker 的
流行，解決了微服務架構的系統佈署問題，而熱門了起來，因此這個 session 我就把主題定在分享我自己公司的 project, 如何將傳統的大型 web application
改為 microservice architecture 的經驗談。

其實我準被的內容，包含 demo, 若是要講個 4hr 也是夠講的... XD，裡面其實太多細節跟經驗值得分享的。既然當天的場子講不完，我就整理一下用文字的
方式在這邊分享吧。我會分成這幾個章節，分成三篇文章來說明:
1. 微服務架構設計
2. 必要的技術: 透過 container 佈署服務 (demo: windows container)
3. 實際案例說明 (參考 stackoverflow.com 的架構，及我們公司自己系統的改版經驗)

<!--more-->

# 前言

其實一開始本來有埋了一些梗，後來都拿掉了.. 很多新技術的導入 (尤其是企業內有時程壓力的狀況下)，往往碰到最大的問題都是人，而不是技術本身。
我常跟別人聊到，最頭痛的狀況就是有些專家，他拿他的專業能力來潑你冷水，而不是拿來解決問題。怎麼說? 因為這些專家夠專業，所以能夠馬上舉出
十個新技術的缺點，來說明導入會有什麼困難。就因為這些人是專家，有時你還真沒辦法反駁他。但是很多事情不下定決心改善，是不會成功的。這時如何
說服這些專家，就是推廣新技術能否成功的主要因素了。

隨便舉個例子，下列的對話是真正發生過的 case:
![被刪掉的投影片 - 常會不自覺潑冷水的專家](/wp-content/uploads/2016/09/microservice-slides-03.PNG)

當然，最後我們並沒有被這些冷水澆熄改變架構的念頭 (不然就沒這個分享的 session 了)，第一階段的調整也順利上線，接下來更大規模的佈署則要
看看 windows server 2016 上市之後再來評估... 不過對話內點到兩個問題，就是我們改用微服務架構碰到的困難:
1. 我們是用 .NET solution, 但是理想架構下，同時會需要 .NET + Open Source solutions
2. Open Source solutions 大都是在 Linux 上面的表現最好，大規模佈署的話會有混搭 (windows + linux) 的需要
3. 微服務架構若沒有搭配 container, 佈署過程會變的很辛苦, 可是當紅的 Docker 是依賴 Linux Kernel 的 container engine ...

這些問題，在後面的介紹都會提到如何因應的，因此這邊我就不多說。先從基礎來說明，為何我們需要用微服務架構。


# 微服務(microservices) vs 單體式架構(monolithic)

先來看張圖:
![單體式架構(monolithic) vs 微服務(microservices)](/wp-content/uploads/2016/09/microservice-slides-06.PNG)

這張圖應該這樣看，上面的 App1 代表的就是你開發的應用程式。裡面的小方塊，我們可以把他看成你的系統內幾個主要的模組。
過去開發的觀念，這些模組主要都是用 "元件" (component) 或是 "函示庫" (library) 的方式提供，然後由開發人員把他組裝
成你的 App 提供給客戶使用。這種組裝方式，最終會產出一個規模龐大的 App, 就是這張圖左方的 Monolithic application approach 的
例子。

通常這類 App, 在 IT 維運的眼光來看，他就是一個不可切割的 Application, 他通常會在一個 process 內執行。安裝設定時
這些模組通常無法再切割為更小的佈署單位。因此效能不足時，只能整個 App 再佈署第二套做 load balance. 用我們的案例來看，我們
App 包含報表模組，也包含教材(影片)管理模組。報表模組是 CPU bound, 通常吃 CPU / RAM 的效能。而教材管理模組則是 I/O bound, 吃的
是 DISK / RAM 效能。最近我們又加了影片重新編碼的功能，太棒了... 這是另一個吃 CPU + RAM + DISK 的模組...。

每個模組其實都有它不同的效能特性，硬要裝在同一台 SERVER 的話，那 IT 大概也沒選擇了，必須提供足夠的規格硬體來安裝。一台跑不動時
就再裝第二台，即使第一台只是因為 CPU 滿載，就算 RAM 跟 DISK 還很空閒，IT 仍然必須用一樣的規格再擴充第二套。當你的 App 規模越大，
這樣的問題會越明顯。

除了效能及資源使用率的問題之外，故障隔離的問題也是。單體式的 APP，通常會整個在同一個 Process 內執行。好一點的開發團隊，可能會把
他切成數個 app pool, 但是基本的問題差不了多少，其中一個元件掛掉的話，你的整個 App 大概也就毀了。要做到部分功能降級，這是相當考驗
開發團隊功力的問題啊。通常，碰到單一模組 fail, 大概就會把整個 App 拖下水了，剩下的就是重新啟動 App 來解決。






# 為何要轉移到微服務架構?



